---
title: "Final Project Shiny App"
output: flexdashboard::flex_dashboard
runtime: shiny
---


```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(rmarkdown)
library(knitr)
library(Hmisc)
library(DT)
library(lubridate)
library(choroplethr)
library(choroplethrZip)
library(tidyverse)
library(data.table)

assignInNamespace("cedta.override", c(data.table:::cedta.override,"rmarkdown"), "data.table")


opts_chunk$set(echo = FALSE, comment="", warning = FALSE, message = FALSE, tidy.opts=list(width.cutoff=55), tidy = TRUE)

```

```{r load_data}
setwd("~/Columbia/AppliedDS/FinalProject/AppliedDataScienceFinalProject")
all.data <- fread("Data/NYCRealEstateFullData.csv", verbose = FALSE)
```

```{r constants}
old.borough.name <- "BOROUGH"
borough.name <- "Fixed Borough"
neighborhood.name <- "NEIGHBORHOOD"
building.class.name <- "BUILDING CLASS CATEGORY"
tax.class.name <- "TAX CLASS AT PRESENT"
block.name <- "BLOCK"
lot.name <- "LOT"
easement.name <- "EASE-MENT"
building.class.present.name <- "BUILDING CLASS AT PRESENT"
address.name <- "ADDRESS"
apartment.number.name <- "APARTMENT NUMBER"
zip.name <- "ZIP CODE"
residential.name <- "RESIDENTIAL UNITS"
commercial.name <- "COMMERCIAL UNITS"
total.units.name <- "TOTAL UNITS"
land.square.feet.name <- "LAND SQUARE FEET"
gross.square.feet.name <- "GROSS SQUARE FEET"
year.built.name <- "YEAR BUILT"
tax.class.sale.name <- "TAX CLASS AT TIME OF SALE"
building.class.sale.name <- "BUILDING CLASS AT TIME OF SALE"
sale.price.name <- "SALE PRICE"
sale.date.name <- "SALE DATE"
sale.year.name <- "Sale Year"
log.price.name <- "Log Price"
building.class.first.letter <- "Building Class First Letter"

all.data <- all.data[, `Sale Year` := year(get(sale.date.name))]
all.data[, `Building Class First Letter` := substr(get(building.class.sale.name), 1, 1)]
dat <- all.data[get(sale.price.name) > 50000]

year.variables <- unique(all.data[, get(sale.year.name)])
first.letter.variables <- unique(all.data[, get(building.class.first.letter)])
residential.codes <- c("A", "B", "C", "D", "RR", "R1", "R2", "R3", "R4", "R6", "R7", "R8", "R9")
line.variables <- c(borough.name, building.class.first.letter)
```

```{r functions}
graph.choropleth <- function(data, year){
  keep_cols = c(zip.name, sale.price.name)
  data(zip.regions)
  zip.prices <- data[, ..keep_cols]
  zip.prices <- zip.prices[, mean(get(sale.price.name), na.rm = TRUE), by = zip.name]
  colnames(zip.prices) <- c("region", "value")
  zip.prices$value <- as.numeric(zip.prices$value)
  zip.prices$region <- as.character(zip.prices$region)
  zip.prices <- zip.prices[region %in% zip.regions$region,]
  zip.prices <- zip.prices[value > 0,]
  
  plot.title <- c(year, " Average Sale Price by Zip Code")
  plot.title <- paste(plot.title, collapse="")
  
  choro.graph <- zip_choropleth(zip.prices,
                 zip_zoom = zip.prices$region,
                 title       =  plot.title,
                 legend      = "Average Sale Price")
  return (choro.graph)
}

avg.sale.price.by <- function(data, by.column.names){
  mean.price <- data[, .(`Avg. Price` = mean(get(sale.price.name), na.rm=TRUE)), by = by.column.names]
  return (mean.price)
}
```

Introduction
=====================================  

For our final project, we decided to analyze New York City real estate data between 2003 and 2017. The data is linked here: https://www1.nyc.gov/site/finance/taxes/property-annualized-sales-update.page

Click on the tabs to see different reports.


Choropleth Map
=====================================

Column {data-width=500}
-------------------------------------

```{r choropleth_map_1}
# maybe include two charts so that you can have a side-by-side comparison

inputPanel(
  selectInput(inputId="year_variable_1", label = "Select Year 1:", choices = sort(year.variables), selected = sort(year.variables)[length(year.variables)]),
  selectInput(inputId="building_class_type_1", label = "Select Building Class Type 1:", choices = first.letter.variables, selected = residential.codes, multiple = TRUE)
)

renderPlot({
  choropleth.dat <- dat[get(sale.year.name) == input$year_variable_1 & get(building.class.first.letter) %in% input$building_class_type_1,]
  graph.choropleth(choropleth.dat, input$year_variable_1)
})
```

Column {data-width=500}
-------------------------------------

```{r choropleth_map_2}
inputPanel(
  selectInput(inputId="year_variable_2", label = "Select Year 2:", choices = sort(year.variables), selected = sort(year.variables)[length(year.variables)-1]),
  selectInput(inputId="building_class_type_2", label = "Select Building Class Type 2:", choices = first.letter.variables, selected = residential.codes, multiple = TRUE)
)

renderPlot({
  choropleth.dat <- dat[get(sale.year.name) == input$year_variable_2 & get(building.class.first.letter) %in% input$building_class_type_2,]
  graph.choropleth(choropleth.dat, input$year_variable_2)
})
```


Time-Series 
=====================================

Row {data-width=800}
-------------------------------------

```{r line_graph}
inputPanel(
  selectInput(inputId="line_variable", label = "Select Variable to Color By:", choices = line.variables, selected = line.variables[1]),
  selectInput(inputId="line_building_class_type", label = "Select Building Class Type:", choices = first.letter.variables, selected = residential.codes, multiple = TRUE)
)

renderPlot({
  if (input$line_variable == building.class.first.letter){
    sub.dat <- dat[get(building.class.first.letter) %in% input$line_building_class_type,]
    mean.price <- avg.sale.price.by(sub.dat, c(sale.year.name, input$line_variable))
    setorderv(x = mean.price, cols = "Sale Year", order = 1)
    # mean.price <- mean.price %>% mutate(input$line_variable = forcats::fct_reorder2(input$line_variable, `Sale Year`, `Avg. Price`))
    
    price.plot <- ggplot(mean.price, aes(`Sale Year`, as.integer(`Avg. Price`), color = `Building Class First Letter`)) + 
                   geom_line(size = 1) + geom_point(aes(`Sale Year`,as.integer(`Avg. Price`))) +
                   xlab("Sale Year") + ylab("Avg. Price") + labs(color = "Building Class") +
                   scale_x_continuous(breaks = scales::pretty_breaks(length(unique(mean.price$`Sale Year`)))) +
                   ggtitle("NYC Avg. Residential Real Estate Price by Building Class & Year") 

    price.plot
  }
  else{
    sub.dat <- dat
    mean.price <- avg.sale.price.by(sub.dat, c(sale.year.name, input$line_variable))
    setorderv(x = mean.price, cols = "Sale Year", order = 1)
    # mean.price <- mean.price %>% mutate(input$line_variable = forcats::fct_reorder2(input$line_variable, `Sale Year`, `Avg. Price`))
    
    price.plot <- ggplot(mean.price, aes(`Sale Year`, as.integer(`Avg. Price`), color = `Fixed Borough`)) + 
                   geom_line(size = 1) + geom_point(aes(`Sale Year`,as.integer(`Avg. Price`))) +
                   xlab("Sale Year") + ylab("Avg. Price") + labs(color = "Borough") +
                   scale_x_continuous(breaks = scales::pretty_breaks(length(unique(mean.price$`Sale Year`)))) +
                   ggtitle("NYC Avg. Residential Real Estate Price by Borough & Year") 

    price.plot
  }
})


```